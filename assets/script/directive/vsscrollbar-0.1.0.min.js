/* 
*  Name: vsscrollbar 
*  Description: Virtual scroll with filtering and custom scrollbar - AngularJS UI component 
*  Version: 0.1.0 
*  Author: kekeh 
*  License: MIT 
*  Date: 2015-04-16 
*/ 
angular.module('template-vsscrollbar-0.1.0.html', ['templates/vsscrollbar.html']);

angular.module("templates/vsscrollbar.html", []).run(["$templateCache", function($templateCache) {
  $templateCache.put("templates/vsscrollbar.html",
    "<table class=\"vsscrollbarcontainer\" style=\"border-collapse: separate; border-spacing: 0; padding: 0; height: 100%;\">\n" +
    "    <tr>\n" +
    "        <td style=\"width: 100%; padding: 0; vertical-align: top;\">\n" +
    "            <div class=\"vsscrollbarcontent\" style=\"margin: 1px; overflow-y: hidden; padding: 0; outline: 0;\" ng-transclude></div>\n" +
    "        </td>\n" +
    "        <td style=\"padding: 0; height: 100%;\">\n" +
    "            <div class=\"vsscrollbar\" ng-show=\"scrollbarVisible\" style=\"float: right; height: 100%; padding: 0; margin: 1px 1px 1px 0px;\">\n" +
    "                <div class=\"vsscrollbox\" tabindex=\"0\" ng-style=\"{'height': boxHeight + 'px'}\"\n" +
    "                     ng-click=\"$event.stopPropagation();\" style=\"position: relative; padding: 0; outline: 0;\"></div>\n" +
    "            </div>\n" +
    "        </td>\n" +
    "    </tr>\n" +
    "</table> \n" +
    "");
}]);

angular.module("vsscrollbar",["template-vsscrollbar-0.1.0.html"]).constant("vsscrollbarConfig",{ITEMS_IN_PAGE:6,SCROLLBAR_HEIGHT:0,SCROLLBOX_MIN_HEIGHT:18}).factory("vsscrollbarEvent",function(){function a(a,b,c){a.$broadcast("vsmessage",{type:b,value:c})}var b={};return b.setIndex=function(b,c){a(b,"setIndex",c)},b.setPosition=function(b,c){a(b,"setPosition",c)},b.filter=function(b,c){a(b,"filter",c)},b.addItem=function(b,c,d){a(b,"addItem",{index:c,item:d})},b.updateItem=function(b,c,d){a(b,"updateItem",{index:c,item:d})},b.deleteItem=function(b,c){a(b,"deleteItem",c)},b}).service("vsscrollbarService",function(){this.calcIndex=function(a,b,c){var d=0;return this.checkIsMaxPos(a,c)?d=b:a>0&&(d=this.validateIndex(Math.round(a/c*b),b)),d},this.calcScrollPos=function(a,b,c){var d=0;return a>0&&(d=this.checkIsMaxIndex(a,b)?c:Math.round(a/b*c)),this.validatePos(d,c,a,b)},this.validateIndex=function(a,b){return 0>=a?0:this.checkIsMaxIndex(a,b)?b:a},this.validatePos=function(a,b,c,d){return angular.isUndefined(c)||angular.isUndefined(d)?0>=a?0:a>=b?b:a:0>=a&&c>0?1:a>=b&&d>c?b-1:a},this.checkIsMaxIndex=function(a,b){return a>=b},this.checkIsMaxPos=function(a,b){return a>=b}}).directive("vsscrollbar",["$filter","$timeout","$document","vsscrollbarService","vsscrollbarConfig",function(a,b,c,d,e){return{restrict:"AE",scope:{ngModel:"=?",items:"=items",onScrollChangeFn:"&"},transclude:!0,templateUrl:"templates/vsscrollbar.html",link:function(f,g,h){function i(a){a.preventDefault(),E=angular.isUndefined(a.changedTouches)?a.clientY-H:a.changedTouches[0].clientY-H,c.on(angular.isUndefined(a.changedTouches)?"mousemove":"touchmove",j),c.on(angular.isUndefined(a.changedTouches)?"mouseup":"touchend",k)}function j(a){var b=angular.isUndefined(a.changedTouches)?a.clientY-E:a.changedTouches[0].clientY-E;r(d.validatePos(b,I)),f.$apply()}function k(a){c.off(angular.isUndefined(a.changedTouches)?"mousemove":"touchmove",j),c.off(angular.isUndefined(a.changedTouches)?"mouseup":"touchend",k)}function l(a){E=a.changedTouches[0].clientY,c.on("touchmove",m),c.on("touchend",n)}function m(a){a.preventDefault();var b=a.changedTouches[0].clientY;t(E>b?C:-C),E=b,f.$apply()}function n(){c.off("touchmove",m),c.off("touchend",n)}function o(a){a.preventDefault();var b=(a.wheelDelta||-a.detail)<=0;t(b?C:-C)}function p(b,c){J=""===b?f.items:a("filter")(f.items,b),f.scrollbarVisible=J.length>C,q(),s(c,!1)}function q(){var a=Math.floor(D/(J.length/C));f.boxHeight=a<e.SCROLLBOX_MIN_HEIGHT?e.SCROLLBOX_MIN_HEIGHT:a,G=J.length-C<0?0:J.length-C,I=D-f.boxHeight<0?0:D-f.boxHeight}function r(a){(a=Math.round(a))!==H&&(H=a,F=d.calcIndex(H,G,I),u())}function s(a,b){(a=d.validateIndex(a,G))===F&&b||(F=a,H=d.calcScrollPos(F,G,I),u())}function t(a){s(F+a,!0),f.$apply()}function u(){B.css("top",H+"px"),v()}function v(){var a={topIndex:F,maxIndex:G,topPos:H,maxPos:I,filteredPageCount:J.length/C,filteredItemCount:J.length,visibleItems:w()};f.onScrollChangeFn(a),f.ngModel=a}function w(){return J.slice(F,F+C)}function x(){J=f.items,0===D?b(y,0):(A.css("height",D+"px"),q()),s(0,!1)}function y(){D=z.prop("offsetHeight"),A.css("height",D+"px"),q()}var z=angular.element(g[0].querySelector(".vsscrollbarcontent")),A=angular.element(g[0].querySelector(".vsscrollbar")),B=A.children(),C=angular.isUndefined(h.itemsInPage)?e.ITEMS_IN_PAGE:f.$eval(h.itemsInPage),D=angular.isUndefined(h.height)?e.SCROLLBAR_HEIGHT:f.$eval(h.height),E=0,F=0,G=0,H=0,I=0,J=[],K="";f.boxHeight=e.SCROLLBOX_MIN_HEIGHT,f.scrollbarVisible=!0,B.on("mousedown touchstart",i),z.on("touchstart",l),A.on("click",function(a){var b=a.offsetY||a.layerY;r(d.validatePos(b<f.boxHeight?0:b,I)),f.$apply()}),B.on("click",function(){B[0].focus()}),z.on("mousewheel DOMMouseScroll",o),A.on("mousewheel DOMMouseScroll",o),B.on("keydown",function(a){a.preventDefault(),38===a.which?t(-C):40===a.which&&t(C)}),f.$on("vsmessage",function(a,b){"setIndex"===b.type&&b.value!==F&&b.value>=0?s(Math.round(b.value),!0):"setPosition"===b.type&&b.value!==H&&b.value>=0?r(d.validatePos(Math.round(b.value),I)):"filter"===b.type?(K=b.value,p(K,0)):"addItem"===b.type&&b.value.index>=0&&b.value.index<=f.items.length?(f.items.splice(b.value.index,0,b.value.item),p(K,F)):"updateItem"===b.type&&b.value.index>=0&&b.value.index<f.items.length?(f.items[b.value.index]=b.value.item,p(K,F)):"deleteItem"===b.type&&b.value>=0&&b.value<f.items.length&&(f.items.splice(b.value,1),p(K,F))}),x()}}}]);